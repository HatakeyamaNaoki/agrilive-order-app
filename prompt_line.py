def get_line_order_prompt():
    """
    LINE注文画像解析用のシステムプロンプトを取得
    """
    return """以下の画像に含まれる注文内容を、JSON形式で構造化してください。

## 出力形式
以下のJSON形式で出力してください：

```json
{
  "order_id": "",
  "order_date": "",
  "delivery_date": "納品希望日（YYYY/MM/DD形式）",
  "partner_name": "",
  "items": [
    {
      "product_name": "商品名",
      "size": "サイズ（S, M, L, 2L, 3L など。判読できる場合のみ）",
      "quantity": "数量（数値のみ）",
      "unit": "単位（個、箱、束、kg、Lなど）",
      "product_code": "",
      "unit_price": "",
      "amount": "",
      "remark": "納品場所・時間・特記事項など（サイズ以外）"
    }
  ]
}
```

## 解析ルール

### 1. 基本情報の抽出
- **order_id**: LINE注文では通常空文字
- **order_date**: 発注日（受信日時を基準とする）
- **delivery_date**: 納品希望日（相対表現は受信日時を基準に計算）
- **partner_name**: LINE送信者名（＠が先頭についている名前は自分の名前であり、取引先ではない）

### 2. 商品情報の抽出
- **商品名**: 商品の正式名称を抽出
- **数量**: 数値のみを抽出（例：「10個」→ quantity: "10"）
- **単位**: 数量の直後の単位を正確に抽出（例：「個」「箱」「束」「kg」「L」など）
- **product_code**: LINE注文では通常空文字
- **unit_price**: LINE注文では通常空文字
- **amount**: LINE注文では通常空文字

### 3. 数量と単位の処理
- 「玉レタス1個」→ 商品名: "玉レタス", 数量: "1", 単位: "個"
- 「青ネギ3束」→ 商品名: "青ネギ", 数量: "3", 単位: "束"
- 商品名に単位が含まれておらず、数量の後に単位がない場合は単位は空文字

### 4. 日付の処理（重要）
- **受信日時基準**: 相対表現は必ず受信日時を基準に計算
- **相対表現の変換**:
  - 「明日」= 受信日時 + 1日
  - 「明後日」= 受信日時 + 2日
  - 「3日後」= 受信日時 + 3日
  - 「来週」= 受信日時 + 7日
- **計算例**:
  - 受信日時: 2025/08/01, 「明日」→ 納品日: 2025/08/02
  - 受信日時: 2025/08/01, 「明後日」→ 納品日: 2025/08/03
- **月またぎ・年またぎ**: 正確に計算（例：8月31日の明日は9月1日）
- **日付形式**: 「YYYY/MM/DD」で統一

### 5. サイズと備考の使い分け（重要）
- **サイズ情報**: 「L」「2L」「3L」「S/M」等のサイズは items[].size に記載
- **備考欄**: サイズ以外の注意事項（納品場所・時間・品質指定「大きめ/小さめ」等）は items[].remark に記載

### 6. 特記事項
- 品質指定（新鮮な、大きいサイズなど）
- 包装指定
- 配達時間指定
- その他の注意事項

### 7. 価格に関する備考の抽出（追加）
- **価格形容詞の抽出**: 「高い／高め／高級／割高／値上げ／高すぎ」「安い／安め／安価／特価／割安／値下げ／安すぎ」等は items[].remark に記載する
- **商品名への混入防止**: 商品名に価格形容詞を含めない
- **活用形の正規化**: 「安く」「高めで」など活用形も正規化して 高い / 安い に統一

### 8. 修飾語（形容詞/指定）の帰属ルール（重要・追加）
- **形容詞が商品名の直前に来た場合**: その形容詞は直後の商品の備考へ
  - 例：高い なし 6 → なし の備考＝高い
- **形容詞が商品名と数量の間に来た場合**: その形容詞はその商品へ
  - 例：いちじく 高い 6 → いちじく の備考＝高い
- **形容詞が商品と商品の間（数量の直後〜次の商品の直前）に現れた場合**: 右側（次の）商品へ帰属
  - 例：いちじく 6 高い なし 6 → なし の備考＝高い
- **文末の形容詞**: 直前の最後の商品へ帰属
- **複数形容詞**: 形容詞は複数あってもよい（スペース区切りで remark に連結）

### 8-2. 改行・行幅制限による形容詞の誤帰属を防ぐルール（最重要・追加）
- **改行の無視**: LINEの行幅制限による改行は論理的な区切りではないため、形容詞の帰属判断では無視する
- **視覚的配置 vs 論理的配置**: 画面上で改行されていても、テキストの論理的な順序を優先する
- **改行後の形容詞の帰属ルール**:
  - 改行の直後に形容詞が来た場合、その形容詞は**次の商品**に帰属する
  - 例：いちじく6\n高い\nなし6 → なし の備考＝高い（いちじくではない）
- **改行前後の文脈保持**: 改行があっても、前後の商品名と数量の関係を維持して判断する
- **LINE特有の表示制約**: LINEアプリの行幅制限により、長いテキストが自動改行されることを考慮する

### 9. 同音異義語の判別（特に「なし/梨」）（最重要・追加）
- **「なし/ナシ」の判別ルール**:
  - **数量を後続する場合**: 果物の「梨」と解釈（商品名は「なし」ではなく「梨」に正規化）
    - 例：なし 6 / ナシ6 → 商品名＝梨，数量＝6
  - **助詞や名詞に接続している場合**: 否定（存在しない/不要）の意味。これは商品ではなく備考に入れる
    - 例：袋なし → 直近（または直後）の商品の備考に 袋なし
  - **形容詞＋「なし」＋数量の並び**: 「梨（商品）」＋備考＝形容詞と解釈
    - 例：高い なし 6 → 商品名＝梨，数量＝6，備考＝高い
- **青果ドメインでの優先ルール**: 不確実な場合でも、青果ドメインでは なし(数量あり) は 梨 を強く優先する。否定の「なし」は数量を伴わないことが多い
- **その他の同音異義語**: 「かき/柿」「うめ/梅」「もも/桃」など ひらがな→標準和名の漢字に正規化（誤って否定語に吸収しない）

### 10. 出力の自己チェック（追加）
- **商品名の品質チェック**: 商品名に「高い/安い/無し」等が混ざっていないかを確認。混入していたら商品名から除去し、備考へ移す
- **数量の存在確認**: 各商品に数量があるかを確認（数量なしの単語は備考の一部とみなす）
- **論理的一貫性**: 商品名、数量、単位の組み合わせが論理的に一貫しているかを確認

### 11. 視覚的配置と論理的配置の区別（重要・追加）
- **改行の論理的解釈**: 画面上の改行位置は、LINEアプリの表示制約によるものであり、注文内容の論理的な区切りではない
- **テキストの連続性**: 改行があっても、テキスト全体を一つの連続した注文リストとして解釈する
- **形容詞の位置判断**: 形容詞の帰属は、画面上の位置ではなく、テキスト内での論理的な順序で判断する
- **改行前後の文脈**: 改行の前後で商品名と数量の対応関係を維持し、形容詞は適切な商品に帰属させる
- **LINE特有の制約理解**: LINEアプリの行幅制限により、長いテキストが自動的に改行されることを理解し、これを考慮した解析を行う

## 重要な指示
- 画像から読み取れる情報のみを抽出
- 推測は避け、確実な情報のみを記載
- 商品名は一般的な名称に統一
- 数量は数字のみ（漢数字は算用数字に変換）
- サイズは size フィールドに、その他の注意事項は備考欄に記載
- 読み取りができない場合でも、謝罪や案内文は出力せず、読み取れる範囲でデータのみを返す
- **納品日の計算は必ず受信日時を基準に行う**
- **受信日時が提供されている場合は、その日付を発注日として使用する**
- **改行の解釈**: LINEの行幅制限による改行は論理的な区切りではない。形容詞の帰属は画面上の位置ではなく、テキストの論理的な順序で判断する
- **改行後の形容詞**: 改行の直後に形容詞が来た場合、その形容詞は次の商品に帰属する

## 例

### 例1（基本ケース）
入力画像：LINEで「明日 玉レタス1個 りんご10個 お願いします！」
受信日時：2025/08/01

出力：
```json
{
  "order_id": "",
  "order_date": "2025/08/01",
  "delivery_date": "2025/08/02",
  "partner_name": "はたけやま",
  "items": [
    {
      "product_name": "玉レタス",
      "size": "",
      "quantity": "1",
      "unit": "個",
      "product_code": "",
      "unit_price": "",
      "amount": "",
      "remark": ""
    },
    {
      "product_name": "りんご",
      "size": "",
      "quantity": "10",
      "unit": "個",
      "product_code": "",
      "unit_price": "",
      "amount": "",
      "remark": ""
    }
  ]
}
```

### 例2（今回のケース：形容詞の帰属と同音異義語）
入力テキスト：いちじく6高いなし6
受信日時：2025/08/01

出力：
```json
{
  "order_id": "",
  "order_date": "2025/08/01",
  "delivery_date": "2025/08/01",
  "partner_name": "（送信者名）",
  "items": [
    {
      "product_name": "いちじく",
      "size": "",
      "quantity": "6",
      "unit": "個",
      "product_code": "",
      "unit_price": "",
      "amount": "",
      "remark": ""
    },
    {
      "product_name": "梨",
      "size": "",
      "quantity": "6",
      "unit": "個",
      "product_code": "",
      "unit_price": "",
      "amount": "",
      "remark": "高い"
    }
  ]
}
```

### 例2-2（改行がある場合：LINEの行幅制限による改行）
入力テキスト（改行あり）：
いちじく6
高い
なし6

受信日時：2025/08/01

出力：
```json
{
  "order_id": "",
  "order_date": "2025/08/01",
  "delivery_date": "2025/08/01",
  "partner_name": "（送信者名）",
  "items": [
    {
      "product_name": "いちじく",
      "size": "",
      "quantity": "6",
      "unit": "個",
      "product_code": "",
      "unit_price": "",
      "amount": "",
      "remark": ""
    },
    {
      "product_name": "梨",
      "size": "",
      "quantity": "6",
      "unit": "個",
      "product_code": "",
      "unit_price": "",
      "amount": "",
      "remark": "高い"
    }
  ]
}
```
**重要**: 改行があっても「高い」は「なし」に帰属する（いちじくではない）

### 例3（形容詞が商品の前）
入力：安い みかん 10
出力：みかん remark=安い

### 例4（形容詞が商品と数量の間）
入力：トマト 高め 5箱
出力：トマト remark=高い（正規化）

### 例5（否定の「なし」）
入力：袋なし ぶどう2
出力：ぶどう remark=袋なし

### 例6（曖昧ひらがなの正規化）
入力：かき3 うめ5
出力：商品名=柿 と 梅

画像を注意深く分析し、上記の形式で正確なデータを抽出してください。""" 