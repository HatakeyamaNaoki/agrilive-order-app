def get_line_order_prompt():
    """
    LINE注文画像解析用のシステムプロンプトを取得
    """
    return """以下の画像に含まれる注文内容を、JSON形式で構造化してください。

## 出力形式
以下のJSON形式で出力してください：

```json
{
  "order_id": "",
  "order_date": "",
  "delivery_date": "納品希望日（YYYY/MM/DD形式）",
  "partner_name": "",
  "items": [
    {
      "product_name": "商品名",
      "size": "サイズ（S, M, L, 2L, 3L など。判読できる場合のみ）",
      "quantity": "数量（数値のみ）",
      "unit": "単位（個、箱、束、kg、Lなど）",
      "product_code": "",
      "unit_price": "",
      "amount": "",
      "remark": "納品場所・時間・特記事項など（サイズ以外）"
    }
  ]
}
```

## 解析ルール

### 0. 事前ルール（入力正規化）
- **改行の無視**: 改行は句読点と同様にただの空白として扱い、意味を持たせない（LINEの折返しは無視する）
- **文字正規化**: 全角/半角・漢数字は正規化して扱ってよい（例：６→6）
- **単位の結合**: 単位（個/玉/束/箱/パック/袋/本/株/g/グラム/kg/キロ など）は数量に結合して解釈する
- **視覚的配置の無視**: 画面上の改行位置は論理的な区切りではないため、形容詞の帰属判断では無視する

### 1. 基本情報の抽出
- **order_id**: LINE注文では通常空文字
- **order_date**: 発注日（受信日時を基準とする）
- **delivery_date**: 納品希望日（相対表現は受信日時を基準に計算）
- **partner_name**: LINE送信者名（＠が先頭についている名前は自分の名前であり、取引先ではない）

### 2. 商品情報の抽出
- **商品名**: 商品の正式名称を抽出
- **数量**: 数値のみを抽出（例：「10個」→ quantity: "10"）
- **単位**: 数量の直後の単位を正確に抽出（例：「個」「箱」「束」「kg」「L」など）
- **product_code**: LINE注文では通常空文字
- **unit_price**: LINE注文では通常空文字
- **amount**: LINE注文では通常空文字

### 3. 数量と単位の処理
- 「玉レタス1個」→ 商品名: "玉レタス", 数量: "1", 単位: "個"
- 「青ネギ3束」→ 商品名: "青ネギ", 数量: "3", 単位: "束"
- 商品名に単位が含まれておらず、数量の後に単位がない場合は単位は空文字

### 4. 日付の処理（重要）
- **受信日時基準**: 相対表現は必ず受信日時を基準に計算
- **相対表現の変換**:
  - 「明日」= 受信日時 + 1日
  - 「明後日」= 受信日時 + 2日
  - 「3日後」= 受信日時 + 3日
  - 「来週」= 受信日時 + 7日
- **計算例**:
  - 受信日時: 2025/08/01, 「明日」→ 納品日: 2025/08/02
  - 受信日時: 2025/08/01, 「明後日」→ 納品日: 2025/08/03
- **月またぎ・年またぎ**: 正確に計算（例：8月31日の明日は9月1日）
- **日付形式**: 「YYYY/MM/DD」で統一

### 5. サイズと備考の使い分け（重要）
- **サイズ情報**: 「L」「2L」「3L」「S/M」等のサイズは items[].size に記載
- **備考欄**: サイズ以外の注意事項（納品場所・時間・品質指定「大きめ/小さめ」等）は items[].remark に記載

### 6. 特記事項
- 品質指定（新鮮な、大きいサイズなど）
- 包装指定
- 配達時間指定
- その他の注意事項

### 7. 価格に関する備考の抽出（追加）
- **価格形容詞の抽出**: 「高い／高め／高級／割高／値上げ／高すぎ」「安い／安め／安価／特価／割安／値下げ／安すぎ」等は items[].remark に記載する
- **商品名への混入防止**: 商品名に価格形容詞を含めない
- **活用形の正規化**: 「安く」「高めで」など活用形も正規化して 高い / 安い に統一

### 8. 形容詞（価格メモ等）の抽出と帰属（重要・強化）
- **価格関連語の抽出**: 価格関連の語（例：高い/高め/高級/割高/値上げ、安い/安め/安価/割安/特価/値下げ など）は商品名に含めず、item.remark に入れる
- **活用形の正規化**: 活用形は正規化して「高い」「安い」に統一してよい
- **帰属優先規則**（上から順に適用）:
  1. **形容詞が「商品名の直前」にある** → 直後の商品の備考
  2. **形容詞が「商品Aの数量の直後〜次の商品の直前」にある** → 右側（次の）商品の備考
     - 例：いちじく 6 高い なし 6 → 「高い」はなしへ
  3. **形容詞が文末** → 直前の最後の商品
  4. **形容詞が商品と数量の間** → その商品の備考
- **複数形容詞**: 形容詞は複数あってもよい（半角スペースで結合）
- **右側優先の最終手段**: あいまい時の最終手段として、形容詞は「右側に商品が存在するなら右側へ」「存在しないなら直前へ」の二択

### 8-2. 改行・行幅制限による形容詞の誤帰属を防ぐルール（最重要・追加）
- **改行の無視**: LINEの行幅制限による改行は論理的な区切りではないため、形容詞の帰属判断では無視する
- **視覚的配置 vs 論理的配置**: 画面上で改行されていても、テキストの論理的な順序を優先する
- **改行後の形容詞の帰属ルール**:
  - 改行の直後に形容詞が来た場合、その形容詞は**次の商品**に帰属する
  - 例：いちじく6\n高い\nなし6 → なし の備考＝高い（いちじくではない）
- **改行前後の文脈保持**: 改行があっても、前後の商品名と数量の関係を維持して判断する
- **LINE特有の表示制約**: LINEアプリの行幅制限により、長いテキストが自動改行されることを考慮する

### 8x. 右側結びのハードルール（最優先・上書き）
- **最優先パターン**: 次のパターンに一致した場合、形容詞は左の商品に付けてはならない。必ず**右側（次に出現する商品）**の remark に入れる
- **パターン**: 商品A 数量A [単位A 任意] [改行/空白 任意] 形容詞(価格語) [改行/空白 任意] 商品B 数量B
- **例**: いちじく 6 高い なし 6、いちじく6\n高い\nなし6
- **優先度**: 上記は他のすべての帰属規則より優先する（この条件を満たす限り、形容詞を商品Aに付与してはならない）
- **最後の一押し**: 形容詞が数量（と任意の単位）の直後に出現し、その後2語以内に商品名が現れた場合、形容詞はその商品の備考に帰属させ、直前の商品へは付与しない

### 8y. ストリーム解析手順（内部アルゴリズム指示）
- **左から右への解析**: 左から右にトークン（商品候補 / 数字 / 単位 / 形容詞）を読み、状態を持って解析する
- **商品の確定**: current_item に商品候補が入り、数量が出た時点で current_item を「確定」する
- **形容詞の一時保管**: 確定直後から次の「商品候補」が出るまでに見つかった価格形容詞は pending_mods に一時保管する（ここで左商品に付けてはならない）
- **右側への移行**: 次の「商品候補」を見つけたら、pending_mods をその商品の remark に移してクリアする
- **文末処理**: 文末までに pending_mods が残った場合のみ、最後の商品の remark に付ける
- **価格形容詞の正規化**: 価格形容詞は活用を正規化して「高い」「安い」に統一する（複数可、半角スペース連結）

### 8z. 「なし/梨/無し」の特別扱い（右側優先ルールと組み合わせ）
- **「なし/ナシ + 数量」の解釈**: 果物の「梨」と解釈（商品名は「梨」に正規化）
- **右側優先ルールとの組み合わせ**: したがって … 数量A 高い なし 数量B … は、ハードルールにより「高い」→ 梨
- **否定表現の判別**: 〜なし/無し/抜き/不要（袋なし 等）は否定表現であり、直近の商品の備考
- **青果ドメインでの優先ルール**: あいまいで迷う場合は、数量が続く「なし」＝梨 を強く優先する（青果ドメインの慣用）
- **その他の同音異義語**: かき/柿, うめ/梅, もも/桃 など、ひらがなは標準和名に正規化してよい

### 9. 「なし/梨/無し」の判別（最重要・強化）
- **「なし/ナシ」の判別ルール**:
  - **数量を後続する場合**: 果物の「梨」と解釈（商品名は「梨」に正規化してよい）
    - 例：なし 6 / ナシ6 / 高い なし 6 → 商品名=梨, 数量=6, 備考に必要なら形容詞を付与
  - **語尾接続の場合**: 〜なし/無し/抜き/不要 のように語尾接続（例：袋なし・氷なし）は否定/オプションなしの意味 → 直近または直後の商品の備考
- **青果ドメインでの優先ルール**: あいまいで迷う場合は、数量が続く「なし」＝梨 を強く優先する（青果ドメインの慣用）
- **その他の同音異義語**: かき/柿, うめ/梅, もも/桃 など、ひらがなは標準和名に正規化してよい

### 10. 出力の自己チェック（強化）
- **商品名の品質チェック**: 商品名に「高い/安い/〜なし/無し」等の語が混入していないか確認し、混入していたら商品名から除去して remark に移す
- **数量の存在確認**: すべての items に数量があるか確認（数量が無い語は remark 扱い）
- **論理的一貫性**: 商品名、数量、単位の組み合わせが論理的に一貫しているかを確認
- **形容詞の適切な配置**: 価格関連語が商品名に混入していないか、適切に備考欄に配置されているかを確認

### 11. 視覚的配置と論理的配置の区別（重要・追加）
- **改行の論理的解釈**: 画面上の改行位置は、LINEアプリの表示制約によるものであり、注文内容の論理的な区切りではない
- **テキストの連続性**: 改行があっても、テキスト全体を一つの連続した注文リストとして解釈する
- **形容詞の位置判断**: 形容詞の帰属は、画面上の位置ではなく、テキスト内での論理的な順序で判断する
- **改行前後の文脈**: 改行の前後で商品名と数量の対応関係を維持し、形容詞は適切な商品に帰属させる
- **LINE特有の制約理解**: LINEアプリの行幅制限により、長いテキストが自動的に改行されることを理解し、これを考慮した解析を行う

## 重要な指示
- 画像から読み取れる情報のみを抽出
- 推測は避け、確実な情報のみを記載
- 商品名は一般的な名称に統一
- 数量は数字のみ（漢数字は算用数字に変換）
- サイズは size フィールドに、その他の注意事項は備考欄に記載
- 読み取りができない場合でも、謝罪や案内文は出力せず、読み取れる範囲でデータのみを返す
- **納品日の計算は必ず受信日時を基準に行う**
- **受信日時が提供されている場合は、その日付を発注日として使用する**
- **改行の解釈**: LINEの行幅制限による改行は論理的な区切りではない。形容詞の帰属は画面上の位置ではなく、テキストの論理的な順序で判断する
- **改行後の形容詞**: 改行の直後に形容詞が来た場合、その形容詞は次の商品に帰属する

## 例

### 例1（基本ケース）
入力画像：LINEで「明日 玉レタス1個 りんご10個 お願いします！」
受信日時：2025/08/01

出力：
```json
{
  "order_id": "",
  "order_date": "2025/08/01",
  "delivery_date": "2025/08/02",
  "partner_name": "はたけやま",
  "items": [
    {
      "product_name": "玉レタス",
      "size": "",
      "quantity": "1",
      "unit": "個",
      "product_code": "",
      "unit_price": "",
      "amount": "",
      "remark": ""
    },
    {
      "product_name": "りんご",
      "size": "",
      "quantity": "10",
      "unit": "個",
      "product_code": "",
      "unit_price": "",
      "amount": "",
      "remark": ""
    }
  ]
}
```

### 例2（今回のケース：形容詞の帰属と同音異義語）
入力テキスト：いちじく6高いなし6
受信日時：2025/08/01

出力：
```json
{
  "order_id": "",
  "order_date": "2025/08/01",
  "delivery_date": "2025/08/01",
  "partner_name": "（送信者名）",
  "items": [
    {
      "product_name": "いちじく",
      "size": "",
      "quantity": "6",
      "unit": "個",
      "product_code": "",
      "unit_price": "",
      "amount": "",
      "remark": ""
    },
    {
      "product_name": "梨",
      "size": "",
      "quantity": "6",
      "unit": "個",
      "product_code": "",
      "unit_price": "",
      "amount": "",
      "remark": "高い"
    }
  ]
}
```

### 例2-2（改行がある場合：LINEの行幅制限による改行）
入力テキスト（改行あり）：
いちじく6
高い
なし6

受信日時：2025/08/01

出力：
```json
{
  "order_id": "",
  "order_date": "2025/08/01",
  "delivery_date": "2025/08/01",
  "partner_name": "（送信者名）",
  "items": [
    {
      "product_name": "いちじく",
      "size": "",
      "quantity": "6",
      "unit": "個",
      "product_code": "",
      "unit_price": "",
      "amount": "",
      "remark": ""
    },
    {
      "product_name": "梨",
      "size": "",
      "quantity": "6",
      "unit": "個",
      "product_code": "",
      "unit_price": "",
      "amount": "",
      "remark": "高い"
    }
  ]
}
```
**重要**: 改行があっても「高い」は「なし」に帰属する（いちじくではない）

### 例2-3（改行に見える折返しは無視）
入力：いちじく6 高い なし6（折返しで「高い」が単独行に見えても同じ）
期待出力（要点のみ）：
```json
{
  "items": [
    {"product_name": "いちじく", "quantity": "6", "unit": "個", "remark": ""},
    {"product_name": "梨",       "quantity": "6", "unit": "個", "remark": "高い"}
  ]
}
```

### 例3（形容詞が商品の前）
入力：安い みかん 10
出力：みかん remark=安い

### 例4（形容詞が商品と数量の間）
入力：トマト 高め 5箱
出力：トマト remark=高い（正規化）

### 例5（否定の「なし」）
入力：袋なし ぶどう2
出力：ぶどう remark=袋なし

### 例6（曖昧ひらがなの正規化）
入力：かき3 うめ5
出力：商品名=柿 と 梅

### 例7（形容詞が右商品へ）
入力：トマト 5 高い きゅうり 10
出力：トマト remark="", きゅうり remark="高い"

### 例8（否定の「〜なし」）
入力：ぶどう2 袋なし
出力：ぶどう remark="袋なし"

### 例9（ひらがな→標準和名）
入力：かき3 うめ5
出力：商品名=柿, 梅

### 例10（右側結びのハードルール適用）
入力：いちじく6\n高い\nなし6
出力（要点）：
```json
{
  "items": [
    {"product_name": "いちじく", "quantity": "6", "unit": "個", "remark": ""},
    {"product_name": "梨",       "quantity": "6", "unit": "個", "remark": "高い"}
  ]
}
```

### 例11（右側結びのハードルール適用）
入力：トマト 5 高い きゅうり 10
出力：トマト remark="", きゅうり remark="高い"

### 例12（否定の「〜なし」）
入力：ぶどう2 袋なし
出力：ぶどう remark="袋なし"

画像を注意深く分析し、上記の形式で正確なデータを抽出してください。""" 